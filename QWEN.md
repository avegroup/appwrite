# Appwrite Project Documentation

## Docker Services Overview

Appwrite использует архитектуру микросервисов на базе Docker. Все сервисы запускаются через `docker-compose` и взаимодействуют друг с другом через общие сети.

### Основные контейнеры:

- **appwrite** - основной API-сервер, обрабатывает HTTP-запросы и предоставляет основные API-функции
- **appwrite-traefik** - обратный прокси и балансировщик нагрузки, обрабатывает маршрутизацию запросов
- **appwrite-console** - веб-интерфейс для управления проектами и пользователями
- **appwrite-realtime** - сервис для работы с WebSockets и реал-тайм обновлениями
- **mariadb** - база данных для хранения информации о пользователях, документах и настройках
- **redis** - кэш и система очередей для быстрого доступа к данным
- **openruntimes-executor** - выполнение пользовательских функций (Cloud Functions)
- **openruntimes-proxy** - прокси для распределения запросов между рантаймами

### Воркер-сервисы:

- **appwrite-worker-*** - набор воркеров для обработки фоновых задач:
  - `audits` - аудит действий пользователей
  - `webhooks` - отправка вебхук-запросов
  - `deletes` - удаление пользовательских данных
  - `databases` - операции с базами данных
  - `functions` - выполнение Cloud Functions
  - `mails` - отправка электронных писем
  - `messaging` - отправка уведомлений
  - `migrations` - миграции данных
  - `certificates` - обработка SSL-сертификатов

### Служебные сервисы:

- **appwrite-task-*** - сервисы для выполнения регулярных задач:
  - `maintenance` - обслуживание и очистка
  - `scheduler-*` - планировщики различных задач
  - `stats-*` - сбор статистики

## Authorization System

### OAuth2 Authentication

Appwrite поддерживает авторизацию через различные OAuth-провайдеры, включая Яндекс. Система OAuth2 реализована с использованием следующей архитектуры:

#### File Structure
- `/src/Appwrite/Auth/OAuth2/` - классы провайдеров OAuth2
- `/app/controllers/api/account.php` - обработчик OAuth2-сессий
- `/app/config/oAuthProviders.php` - конфигурация доступных провайдеров

#### OAuth2 Process
1. Пользователь инициирует OAuth2-сессию через `/v1/account/sessions/oauth2/:provider`
2. Приложение перенаправляется к провайдеру для аутентификации
3. После успешной аутентификации провайдер возвращает код авторизации
4. Код обменивается на access token
5. Полученные данные пользователя сохраняются в профиль

#### Yandex OAuth2 Specifics
Класс `Yandex.php` в `/src/Appwrite/Auth/OAuth2/` реализует:
- Получение данных пользователя из Яндекса (ID, email, имя, телефон)
- Метод `getUserPhone()` для извлечения номера телефона из профиля Яндекса
- Методы для извлечения дополнительных полей:
  - `getUserAvatar()` - извлекает URL аватара
  - `getUserGender()` - извлекает пол
  - `getUserBirthDate()` - извлекает дату рождения
  - `getUserCountry()` - извлекает страну
  - `getUserCity()` - извлекает город
- Поддержка всех стандартных OAuth2 функций (получение токенов, обновление токенов и т.д.)

#### Changes Made
Были внесены изменения в систему OAuth2 для сохранения дополнительных данных пользователя:
1. В `/src/Appwrite/Auth/OAuth2/Yandex.php` добавлены методы для извлечения дополнительных полей
2. В `/app/controllers/api/account.php` добавлено извлечение и сохранение телефона:
   - Извлечение телефона: `$phone = $oauth2->getUserPhone($accessToken);`
   - Сохранение телефона при создании нового пользователя
   - Обновление телефона при аутентификации существующего пользователя
3. Добавлено извлечение и сохранение дополнительных данных в Preferences:
   - Аватар пользователя сохраняется в `prefs.avatar`
   - Пол пользователя сохраняется в `prefs.gender`
   - Дата рождения сохраняется в `prefs.birthDate`
   - Страна сохраняется в `prefs.country`
   - Город сохраняется в `prefs.city`

### Database Structure
- Коллекция `users` содержит информацию о пользователях, включая поля `phone` и `phoneVerification`
- Коллекция `identities` содержит информацию об OAuth-идентификаторах пользователей
- Коллекция `sessions` содержит информацию о сессиях, включая OAuth-сессии

## Testing OAuth2 with Phone Number

### Prerequisites
- Убедитесь, что Docker-контейнеры запущены: `docker-compose up -d`
- Настройте OAuth2 провайдера Яндекс в консоли Appwrite
- Убедитесь, что в профиле Яндекса указан номер телефона

### Testing Steps
1. Инициируйте OAuth2 авторизацию через Яндекс
2. После успешной авторизации проверьте, что телефон пользователя сохранен
3. В профиле пользователя должно появиться поле `phone` с номером из Яндекса
4. Убедитесь, что поле `phoneVerification` установлено в `true`

## Troubleshooting

### Common Issues
- Если телефон не сохраняется, проверьте, что в профиле OAuth-провайдера он указан
- Убедитесь, что изменения в `account.php` корректно применены
- Проверьте логи контейнеров в случае ошибок: `docker logs <container_name>`